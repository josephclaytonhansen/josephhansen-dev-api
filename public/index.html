<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Image Admin - josephhansen.dev</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
				background: #f5f5f5;
				color: #333;
			}

			.container {
				max-width: 1200px;
				margin: 0 auto;
				padding: 20px;
			}

			.header {
				background: white;
				padding: 20px;
				border-radius: 8px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				margin-bottom: 20px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.login-form,
			.setup-2fa,
			.verify-2fa {
				background: white;
				padding: 30px;
				border-radius: 8px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				max-width: 400px;
				margin: 50px auto;
				color: #333;
				border: 1px solid #e0e0e0;
			}

			.login-form h2,
			.setup-2fa h2,
			.verify-2fa h2 {
				color: #333;
				margin-bottom: 20px;
			}

			.form-group {
				margin-bottom: 20px;
			}

			label {
				display: block;
				margin-bottom: 5px;
				font-weight: 500;
				color: #333;
			}

			p {
				color: #333;
				line-height: 1.5;
			}

			code {
				background: #f0f0f0;
				padding: 2px 4px;
				border-radius: 3px;
				font-family: monospace;
				color: #333;
			}

			input[type="text"],
			input[type="password"],
			input[type="file"],
			input[type="number"],
			select {
				width: 100%;
				padding: 10px;
				border: 1px solid #ddd;
				border-radius: 4px;
				font-size: 16px;
				background: white;
				color: #333;
				box-sizing: border-box;
			}

			input[type="text"]:focus,
			input[type="password"]:focus,
			input[type="number"]:focus,
			select:focus {
				outline: none;
				border-color: #007acc;
				box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
			}

			button {
				background: #007acc;
				color: white;
				border: none;
				padding: 12px 24px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 16px;
			}

			button:hover {
				background: #005a9e;
			}

			button:disabled {
				background: #ccc;
				cursor: not-allowed;
			}

			.upload-area {
				background: white;
				padding: 20px;
				border-radius: 8px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				margin-bottom: 20px;
			}

			.drop-zone {
				border: 2px dashed #ddd;
				border-radius: 8px;
				padding: 40px;
				text-align: center;
				cursor: pointer;
				transition: border-color 0.3s;
			}

			.drop-zone:hover,
			.drop-zone.dragover {
				border-color: #007acc;
			}

			.image-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
				gap: 20px;
				margin-top: 20px;
			}

			.image-card {
				background: white;
				border-radius: 8px;
				overflow: hidden;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}

			.image-preview {
				width: 100%;
				height: 200px;
				object-fit: cover;
			}

			.image-info {
				padding: 15px;
			}

			.image-actions {
				display: flex;
				gap: 10px;
				margin-top: 10px;
			}

			.btn-small {
				padding: 6px 12px;
				font-size: 14px;
			}

			.btn-danger {
				background: #dc3545;
			}

			.btn-danger:hover {
				background: #c82333;
			}

			.alert {
				padding: 15px;
				margin-bottom: 20px;
				border-radius: 4px;
			}

			.alert-success {
				background: #d4edda;
				color: #155724;
				border: 1px solid #c3e6cb;
			}

			.alert-error {
				background: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
			}

			.qr-code {
				text-align: center;
				margin: 20px 0;
			}

			.hidden {
				display: none;
			}

			.loading {
				opacity: 0.6;
				pointer-events: none;
			}

			.modal {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.8);
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 1000;
			}

			.modal.hidden {
				display: none !important;
			}

			.modal-content {
				background: white;
				padding: 20px;
				border-radius: 8px;
				max-width: 500px;
				width: 90%;
			}

			.modal-close {
				float: right;
				font-size: 24px;
				cursor: pointer;
				color: #666;
				font-weight: bold;
				line-height: 1;
				margin: -5px;
				padding: 5px;
			}

			.modal-close:hover {
				color: #000;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<!-- Header (only shown after auth) -->
			<div class="header" id="header" style="display: none">
				<h1>Image Admin Panel</h1>
				<div>
					<span id="username-display"></span>
					<button onclick="logout()">Logout</button>
				</div>
			</div>

			<!-- Login Form -->
			<div class="login-form" id="login-form">
				<h2>Login</h2>
				<div class="form-group">
					<label for="username">Username:</label>
					<input type="text" id="username" required />
				</div>
				<div class="form-group">
					<label for="password">Password:</label>
					<input type="password" id="password" required />
				</div>
				<button onclick="login()">Login with Password</button>
				<div style="text-align: center; margin: 15px 0; color: #666">OR</div>
				<button onclick="loginWithPasskey()" style="background: #28a745">
					üîê Login with Windows Hello / Passkey
				</button>
			</div>

			<!-- 2FA Setup -->
			<div class="setup-2fa" id="setup-2fa" style="display: none">
				<h2>Setup Two-Factor Authentication</h2>
				<p>Scan this QR code with your authenticator app:</p>
				<div class="qr-code" id="qr-code"></div>
				<p>Or enter this key manually: <code id="manual-key"></code></p>
				<div class="form-group">
					<label for="setup-token">Enter verification code:</label>
					<input type="text" id="setup-token" placeholder="6-digit code" />
				</div>
				<button onclick="verifySetup()">Complete Setup</button>
			</div>

			<!-- 2FA Verification -->
			<div class="verify-2fa" id="verify-2fa" style="display: none">
				<h2>Two-Factor Authentication</h2>
				<p>Enter the 6-digit code from your authenticator app:</p>
				<div class="form-group">
					<label for="verify-token">Verification code:</label>
					<input type="text" id="verify-token" placeholder="6-digit code" />
				</div>
				<button onclick="verify2FA()">Verify</button>
			</div>

			<!-- Main Admin Panel (created dynamically after auth) -->
			<div id="admin-panel"></div>

			<!-- Alert Container -->
			<div id="alert-container"></div>
		</div>

		<!-- SimpleWebAuthn Browser Library - Using ESM bundle -->
		<script type="module">
			import * as SimpleWebAuthnBrowser from "https://unpkg.com/@simplewebauthn/browser@9.0.1/dist/bundle/index.js"
			window.SimpleWebAuthnBrowser = SimpleWebAuthnBrowser
			console.log("SimpleWebAuthnBrowser loaded:", window.SimpleWebAuthnBrowser)

			// Signal that the library is loaded
			window.dispatchEvent(new Event("simplewebauthn-loaded"))
		</script>

		<script>
			let selectedFiles = []
			let currentImageId = null
			let simpleWebAuthnReady = false

			// Wait for SimpleWebAuthn to load
			window.addEventListener("simplewebauthn-loaded", () => {
				console.log("SimpleWebAuthn ready to use")
				simpleWebAuthnReady = true
			})

			// Check authentication status on load
			window.onload = async function () {
				await getCsrfToken() // Get CSRF token first
				checkAuthStatus()
			}

			// Global CSRF token
			let csrfToken = null

			// Get CSRF token
			async function getCsrfToken() {
				if (!csrfToken) {
					try {
						const response = await fetch("/api/csrf-token", {
							credentials: "include",
						})
						if (response.ok) {
							const data = await response.json()
							csrfToken = data.token
						}
					} catch (error) {
						console.error("Failed to get CSRF token:", error)
					}
				}
				return csrfToken
			}

			// API Helper
			async function apiCall(url, options = {}) {
				try {
					const headers = {
						"Content-Type": "application/json",
						...options.headers,
					}

					// Add CSRF token for POST, PUT, DELETE requests
					if (options.method && options.method !== "GET") {
						const token = await getCsrfToken()
						if (token) {
							headers["x-csrf-token"] = token
						}
					}

					const response = await fetch(url, {
						credentials: "include",
						headers,
						...options,
					})

					// If CSRF error, retry once with fresh token
					if (response.status === 403) {
						const errorData = await response.json().catch(() => ({}))
						if (errorData.error && errorData.error.includes("CSRF")) {
							csrfToken = null // Clear cached token
							const newToken = await getCsrfToken()
							if (newToken && options.method && options.method !== "GET") {
								headers["x-csrf-token"] = newToken
								const retryResponse = await fetch(url, {
									credentials: "include",
									headers,
									...options,
								})
								if (retryResponse.ok) {
									return await retryResponse.json()
								}
							}
						}
					}

					const data = await response.json()

					if (!response.ok) {
						throw new Error(data.error || "Request failed")
					}

					return data
				} catch (error) {
					showAlert(error.message, "error")
					throw error
				}
			}

			// Check authentication status
			async function checkAuthStatus() {
				try {
					const status = await apiCall("/api/auth/status")

					if (!status.authenticated) {
						showLoginForm()
					} else if (status.needsSetup) {
						setup2FA()
					} else if (status.needsVerification) {
						show2FAVerification()
					} else {
						showAdminPanel()
						document.getElementById("username-display").textContent = status.username
					}
				} catch (error) {
					showLoginForm()
				}
			}

			// Show different views
			function showLoginForm() {
				hideAll()
				document.getElementById("login-form").style.display = "block"
			}

			function show2FASetup() {
				hideAll()
				document.getElementById("setup-2fa").style.display = "block"
			}

			function show2FAVerification() {
				hideAll()
				document.getElementById("verify-2fa").style.display = "block"
			}

			function showAdminPanel() {
				hideAll()
				document.getElementById("header").style.display = "flex"
				createAdminInterface()
				loadImages()
				loadPasskeys()
			}

			function hideAll() {
				const elements = ["login-form", "setup-2fa", "verify-2fa", "header"]
				elements.forEach((id) => {
					const element = document.getElementById(id)
					if (element) element.style.display = "none"
				})

				// Clear admin panel
				document.getElementById("admin-panel").innerHTML = ""
			}

			function createAdminInterface() {
				const adminPanel = document.getElementById("admin-panel")
				adminPanel.innerHTML = `
                <!-- Upload Area -->
                <div class="upload-area">
                    <h3>Upload Images</h3>
                    <div class="drop-zone" id="drop-zone">
                        <p>Click here or drag files to upload</p>
                        <input type="file" id="file-input" multiple accept="image/*" style="display: none;">
                    </div>
                    <p style="color: #666; font-size: 13px; margin: 10px 0 0 0;">
                        üìã <strong>Upload Limits:</strong> Maximum 5 files per upload | 10MB per file | Supported: JPEG, PNG, GIF, WebP
                    </p>
                    <button onclick="uploadImages()" id="upload-btn" style="margin-top: 15px;" disabled>Upload Selected Files</button>
                </div>

                <!-- Passkey Management -->
                <div class="upload-area" style="margin-top: 20px;">
                    <h3>üîê Passkey Management</h3>
                    <p style="color: #666; font-size: 14px;">Use Windows Hello, Touch ID, or a security key to sign in securely without passwords.</p>
                    <button onclick="registerPasskey()" style="background: #28a745; margin-bottom: 15px;">
                        ‚ûï Register New Passkey
                    </button>
                    <div id="passkey-list"></div>
                </div>

                <!-- Image Grid -->
                <div class="image-grid" id="image-grid"></div>

                <!-- Image Preview Modal -->
                <div class="modal" id="image-preview-modal" style="display: none;">
                    <div class="modal-content" style="max-width: 80%; max-height: 80%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #333;">Image Details</h3>
                            <span class="modal-close" onclick="closeModal('image-preview-modal')">&times;</span>
                        </div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <img id="preview-image" src="" alt="Preview" style="max-width: 100%; max-height: 400px; object-fit: contain; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div id="preview-info" style="margin-bottom: 20px;"></div>
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="copyImageUrl(document.getElementById('preview-image').src)">Copy URL</button>
                            <button onclick="resizeCurrentImage()">Resize</button>
                            <button onclick="deleteCurrentImage()" style="background: #dc3545;">Delete</button>
                            <button onclick="closeModal('image-preview-modal')" style="background: #6c757d;">Close</button>
                        </div>
                    </div>
                </div>

                <!-- Resize/Crop Modal -->
                <div class="modal" id="resize-modal" style="display: none;">
                    <div class="modal-content" style="max-width: 900px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #333;">‚úÇÔ∏è Resize & Crop Image</h3>
                            <span class="modal-close" onclick="closeModal('resize-modal')">&times;</span>
                        </div>
                        
                        <!-- Tab Navigation -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd;">
                            <button id="resize-tab" onclick="switchResizeTab('resize')" style="padding: 10px 20px; border: none; background: #007acc; color: white; border-radius: 4px 4px 0 0; cursor: pointer;">
                                üìê Resize
                            </button>
                            <button id="crop-tab" onclick="switchResizeTab('crop')" style="padding: 10px 20px; border: none; background: #f5f5f5; color: #666; border-radius: 4px 4px 0 0; cursor: pointer;">
                                ‚úÇÔ∏è Crop
                            </button>
                        </div>

                        <!-- Resize Panel -->
                        <div id="resize-panel" style="display: block;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- Settings -->
                                <div>
                                    <h4 style="margin-top: 0;">Resize Settings</h4>
                                    <div class="form-group">
                                        <label for="resize-width">Width (px):</label>
                                        <input type="number" id="resize-width" placeholder="Leave empty for auto" oninput="updateResizePreview()">
                                    </div>
                                    <div class="form-group">
                                        <label for="resize-height">Height (px):</label>
                                        <input type="number" id="resize-height" placeholder="Leave empty for auto" oninput="updateResizePreview()">
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="maintain-aspect" checked onchange="updateResizePreview()">
                                            Maintain aspect ratio
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label for="resize-quality">Quality (1-100):</label>
                                        <input type="range" id="resize-quality" value="90" min="1" max="100" oninput="document.getElementById('quality-value').textContent = this.value; updateResizePreview()">
                                        <span id="quality-value">90</span>
                                    </div>
                                    <div class="form-group">
                                        <label for="resize-format">Output Format:</label>
                                        <select id="resize-format" onchange="updateResizePreview()">
                                            <option value="png">PNG (lossless)</option>
                                            <option value="jpeg">JPEG (smaller)</option>
                                            <option value="webp">WebP (best)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Preview -->
                                <div>
                                    <h4 style="margin-top: 0;">Preview</h4>
                                    <div id="resize-preview-container" style="border: 2px dashed #ddd; border-radius: 4px; padding: 10px; min-height: 250px; display: flex; align-items: center; justify-content: center; background: #f9f9f9;">
                                        <img id="resize-preview-image" src="" alt="Preview" style="max-width: 100%; max-height: 300px; object-fit: contain; display: none;">
                                        <p id="resize-preview-text" style="color: #999;">Preview will appear here</p>
                                    </div>
                                    <div id="resize-info" style="margin-top: 10px; font-size: 13px; color: #666;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Crop Panel -->
                        <div id="crop-panel" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- Settings -->
                                <div>
                                    <h4 style="margin-top: 0;">Crop Settings</h4>
                                    <div class="form-group">
                                        <label>Aspect Ratio:</label>
                                        <select id="crop-aspect" onchange="updateCropAspect()">
                                            <option value="free">Free Form</option>
                                            <option value="1">1:1 (Square)</option>
                                            <option value="1.333">4:3</option>
                                            <option value="1.777">16:9</option>
                                            <option value="0.5625">9:16 (Portrait)</option>
                                            <option value="1.5">3:2</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="crop-width">Crop Width (px):</label>
                                        <input type="number" id="crop-width" readonly style="background: #f5f5f5;">
                                    </div>
                                    <div class="form-group">
                                        <label for="crop-height">Crop Height (px):</label>
                                        <input type="number" id="crop-height" readonly style="background: #f5f5f5;">
                                    </div>
                                    <div class="form-group">
                                        <label for="crop-x">Position X:</label>
                                        <input type="number" id="crop-x" readonly style="background: #f5f5f5;">
                                    </div>
                                    <div class="form-group">
                                        <label for="crop-y">Position Y:</label>
                                        <input type="number" id="crop-y" readonly style="background: #f5f5f5;">
                                    </div>
                                    <p style="font-size: 13px; color: #666;">
                                        üí° Drag on the image to select crop area
                                    </p>
                                </div>
                                
                                <!-- Crop Canvas -->
                                <div>
                                    <h4 style="margin-top: 0;">Select Crop Area</h4>
                                    <div id="crop-container" style="position: relative; border: 2px solid #ddd; border-radius: 4px; overflow: hidden; background: #f9f9f9; min-height: 300px; display: flex; align-items: center; justify-content: center;">
                                        <canvas id="crop-canvas" style="max-width: 100%; max-height: 400px; cursor: crosshair;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                            <button onclick="closeModal('resize-modal')" style="background: #6c757d;">Cancel</button>
                            <button onclick="performResizeOrCrop()" style="background: #007acc;">Apply Changes</button>
                        </div>
                    </div>
                </div>
            `

				// Setup event listeners after creating the interface
				setupUploadListeners()
			}

			function setupUploadListeners() {
				const fileInput = document.getElementById("file-input")
				const dropZone = document.getElementById("drop-zone")

				if (fileInput) {
					fileInput.addEventListener("change", function (e) {
						selectedFiles = Array.from(e.target.files)
						updateUploadButton()
					})
				}

				if (dropZone) {
					dropZone.addEventListener("click", function () {
						document.getElementById("file-input").click()
					})

					dropZone.addEventListener("dragover", function (e) {
						e.preventDefault()
						dropZone.classList.add("dragover")
					})

					dropZone.addEventListener("dragleave", function (e) {
						e.preventDefault()
						dropZone.classList.remove("dragover")
					})

					dropZone.addEventListener("drop", function (e) {
						e.preventDefault()
						dropZone.classList.remove("dragover")
						selectedFiles = Array.from(e.dataTransfer.files)
						updateUploadButton()
					})
				}
			}

			// Authentication functions
			async function login() {
				const username = document.getElementById("username").value
				const password = document.getElementById("password").value

				if (!username || !password) {
					showAlert("Please enter username and password", "error")
					return
				}

				try {
					await apiCall("/api/auth/login", {
						method: "POST",
						body: JSON.stringify({ username, password }),
					})

					checkAuthStatus()
				} catch (error) {
					// Error already shown by apiCall
				}
			}

			// Passkey Login
			async function loginWithPasskey() {
				try {
					const username = document.getElementById("username").value || "admin"

					showAlert("Touch your security key or use Windows Hello...", "info")

					// Get authentication options from server
					const options = await apiCall("/api/passkey/auth/options", {
						method: "POST",
						body: JSON.stringify({ username }),
					})

					// Start authentication with SimpleWebAuthn library (handles conversion automatically)
					const authResponse = await window.SimpleWebAuthnBrowser.startAuthentication(options)

					// Add username to response
					authResponse.username = username

					// Verify authentication
					await apiCall("/api/passkey/auth/verify", {
						method: "POST",
						body: JSON.stringify(authResponse),
					})

					showAlert("Login successful!", "success")
					checkAuthStatus()
				} catch (error) {
					if (error.name === "NotAllowedError") {
						showAlert("Authentication cancelled or failed", "error")
					} else {
						showAlert(error.message || "Passkey login failed", "error")
					}
				}
			}

			// Register new passkey
			async function registerPasskey() {
				try {
					// Wait for SimpleWebAuthn library to be available
					if (!simpleWebAuthnReady) {
						showAlert("Loading security library, please wait...", "info")
						await new Promise((resolve) => {
							const checkInterval = setInterval(() => {
								if (simpleWebAuthnReady) {
									clearInterval(checkInterval)
									resolve()
								}
							}, 100)
							// Timeout after 5 seconds
							setTimeout(() => {
								clearInterval(checkInterval)
								resolve()
							}, 5000)
						})
					}

					if (!window.SimpleWebAuthnBrowser) {
						throw new Error("Security library failed to load. Please refresh the page.")
					}

					showAlert("Touch your security key or use Windows Hello...", "info")

					console.log("Starting passkey registration...")

					// Get registration options from server
					const options = await apiCall("/api/passkey/register/options", {
						method: "POST",
					})

					console.log("Got options from server:", options)

					// Start registration with SimpleWebAuthn library (handles conversion automatically)
					console.log("Calling startRegistration...")
					const regResponse = await window.SimpleWebAuthnBrowser.startRegistration(options)
					console.log("Got registration response:", regResponse)

					// Verify registration
					await apiCall("/api/passkey/register/verify", {
						method: "POST",
						body: JSON.stringify(regResponse),
					})

					showAlert("Passkey registered successfully! You can now use it to log in.", "success")
					loadPasskeys()
				} catch (error) {
					console.error("Passkey registration error:", error)
					if (error.name === "NotAllowedError") {
						showAlert("Registration cancelled or failed", "error")
					} else {
						showAlert(error.message || "Passkey registration failed", "error")
					}
				}
			}

			// Load user's passkeys
			async function loadPasskeys() {
				try {
					const response = await apiCall("/api/passkey/list")
					const passkeyList = document.getElementById("passkey-list")

					if (!passkeyList) return

					if (response.passkeys.length === 0) {
						passkeyList.innerHTML = '<p style="color: #666;">No passkeys registered yet.</p>'
					} else {
						passkeyList.innerHTML = response.passkeys
							.map(
								(passkey) => `
							<div style="background: white; padding: 15px; margin: 10px 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
								<div>
									<strong>${passkey.name}</strong><br>
									<small style="color: #666;">Created: ${new Date(passkey.createdAt).toLocaleDateString()}</small>
								</div>
								<button onclick="deletePasskey('${passkey.id}')" style="background: #dc3545;">Remove</button>
							</div>
						`
							)
							.join("")
					}
				} catch (error) {
					console.error("Failed to load passkeys:", error)
				}
			}

			// Delete a passkey
			async function deletePasskey(passkeyId) {
				if (!confirm("Are you sure you want to remove this passkey?")) return

				try {
					await apiCall(`/api/passkey/${passkeyId}`, {
						method: "DELETE",
					})

					showAlert("Passkey removed successfully", "success")
					loadPasskeys()
				} catch (error) {
					// Error already shown by apiCall
				}
			}

			async function setup2FA() {
				try {
					const response = await apiCall("/api/auth/setup-2fa")

					document.getElementById("qr-code").innerHTML = `<img src="${response.qrCode}" alt="QR Code">`
					document.getElementById("manual-key").textContent = response.secret
					show2FASetup()
				} catch (error) {
					// Error already shown by apiCall
				}
			}

			async function verifySetup() {
				const token = document.getElementById("setup-token").value

				if (!token) {
					showAlert("Please enter the verification code", "error")
					return
				}

				try {
					await apiCall("/api/auth/verify-2fa-setup", {
						method: "POST",
						body: JSON.stringify({ token }),
					})

					showAlert("2FA setup completed successfully!", "success")
					checkAuthStatus()
				} catch (error) {
					// Error already shown by apiCall
				}
			}

			async function verify2FA() {
				const token = document.getElementById("verify-token").value

				if (!token) {
					showAlert("Please enter the verification code", "error")
					return
				}

				try {
					await apiCall("/api/auth/verify-2fa", {
						method: "POST",
						body: JSON.stringify({ token }),
					})

					checkAuthStatus()
				} catch (error) {
					// Error already shown by apiCall
				}
			}

			async function logout() {
				try {
					await apiCall("/api/auth/logout", { method: "POST" })
					showLoginForm()
				} catch (error) {
					// Error already shown by apiCall
				}
			}

			function updateUploadButton() {
				const btn = document.getElementById("upload-btn")
				const MAX_FILES = 5
				const MAX_FILE_SIZE = 10 * 1024 * 1024 // 10MB

				if (selectedFiles.length > 0) {
					btn.disabled = false

					// Check for issues
					let warning = ""
					if (selectedFiles.length > MAX_FILES) {
						warning = ` ‚ö†Ô∏è Too many files (max ${MAX_FILES})`
						btn.style.background = "#ffc107" // Yellow warning
					} else {
						const oversizedFiles = selectedFiles.filter((f) => f.size > MAX_FILE_SIZE)
						if (oversizedFiles.length > 0) {
							warning = ` ‚ö†Ô∏è ${oversizedFiles.length} file(s) too large`
							btn.style.background = "#ffc107" // Yellow warning
						} else {
							btn.style.background = "#007acc" // Normal blue
						}
					}

					btn.textContent = `Upload ${selectedFiles.length} file(s)${warning}`
				} else {
					btn.disabled = true
					btn.textContent = "Upload Selected Files"
					btn.style.background = "#ccc" // Disabled gray
				}
			}

			async function uploadImages() {
				if (selectedFiles.length === 0) return

				// Client-side validation
				const MAX_FILES = 5
				const MAX_FILE_SIZE = 10 * 1024 * 1024 // 10MB
				const ALLOWED_TYPES = ["image/jpeg", "image/png", "image/gif", "image/webp"]

				// Check file count
				if (selectedFiles.length > MAX_FILES) {
					showAlert(`Too many files selected. Maximum ${MAX_FILES} files allowed per upload.`, "error")
					return
				}

				// Check each file
				for (const file of selectedFiles) {
					// Check file size
					if (file.size > MAX_FILE_SIZE) {
						const sizeMB = (file.size / (1024 * 1024)).toFixed(1)
						showAlert(
							`File "${file.name}" is too large (${sizeMB}MB). Maximum size is 10MB per file.`,
							"error"
						)
						return
					}

					// Check file type
					if (!ALLOWED_TYPES.includes(file.type)) {
						showAlert(
							`File "${file.name}" has an unsupported format. Only JPEG, PNG, GIF, and WebP are allowed.`,
							"error"
						)
						return
					}
				}

				const formData = new FormData()
				selectedFiles.forEach((file) => {
					formData.append("images", file)
				})

				try {
					// Get CSRF token
					const token = await getCsrfToken()

					if (!token) {
						throw new Error("Unable to get security token. Please refresh the page.")
					}

					const response = await fetch("/api/images/upload", {
						method: "POST",
						credentials: "include",
						headers: {
							"x-csrf-token": token,
						},
						body: formData,
					})

					const data = await response.json()

					if (!response.ok) {
						throw new Error(data.error || "Upload failed")
					}

					showAlert(data.message, "success")
					selectedFiles = []
					document.getElementById("file-input").value = ""
					updateUploadButton()
					loadImages()
				} catch (error) {
					showAlert(error.message, "error")
				}
			}

			// Load and display images
			async function loadImages() {
				try {
					const response = await apiCall("/api/images")
					displayImages(response.images)
				} catch (error) {
					// Error already shown by apiCall
				}
			}

			function displayImages(images) {
				const grid = document.getElementById("image-grid")
				grid.innerHTML = ""

				images.forEach((image) => {
					const card = document.createElement("div")
					card.className = "image-card"

					// Create elements safely to prevent XSS
					const img = document.createElement("img")
					img.src = escapeHtml(image.url)
					img.alt = "Image"
					img.className = "image-preview"
					img.style.cursor = "pointer"
					img.onclick = () => showImagePreview(escapeHtml(image.id), escapeHtml(image.url), image)

					const infoDiv = document.createElement("div")
					infoDiv.className = "image-info"

					const idP = document.createElement("p")
					idP.innerHTML = "<strong>ID:</strong> "
					idP.appendChild(document.createTextNode(image.id))

					const sizeP = document.createElement("p")
					sizeP.innerHTML = "<strong>Size:</strong> "
					sizeP.appendChild(document.createTextNode(Math.round(image.size / 1024) + "KB"))

					const dimP = document.createElement("p")
					dimP.innerHTML = "<strong>Dimensions:</strong> "
					dimP.appendChild(document.createTextNode(image.width + "x" + image.height))

					const dateP = document.createElement("p")
					dateP.innerHTML = "<strong>Created:</strong> "
					dateP.appendChild(document.createTextNode(new Date(image.created).toLocaleDateString()))

					const actionsDiv = document.createElement("div")
					actionsDiv.className = "image-actions"

					const copyBtn = document.createElement("button")
					copyBtn.className = "btn-small"
					copyBtn.textContent = "Copy URL"
					copyBtn.onclick = (e) => {
						e.stopPropagation()
						copyImageUrl(image.url)
					}

					const viewBtn = document.createElement("button")
					viewBtn.className = "btn-small"
					viewBtn.textContent = "View"
					viewBtn.onclick = (e) => {
						e.stopPropagation()
						showImagePreview(image.id, image.url, image)
					}

					const deleteBtn = document.createElement("button")
					deleteBtn.className = "btn-small btn-danger"
					deleteBtn.textContent = "Delete"
					deleteBtn.onclick = (e) => {
						e.stopPropagation()
						deleteImage(image.id)
					}

					actionsDiv.appendChild(copyBtn)
					actionsDiv.appendChild(viewBtn)
					actionsDiv.appendChild(deleteBtn)

					infoDiv.appendChild(idP)
					infoDiv.appendChild(sizeP)
					infoDiv.appendChild(dimP)
					infoDiv.appendChild(dateP)
					infoDiv.appendChild(actionsDiv)

					card.appendChild(img)
					card.appendChild(infoDiv)
					grid.appendChild(card)
				})
			}

			// HTML escaping function to prevent XSS
			function escapeHtml(text) {
				const div = document.createElement("div")
				div.textContent = text
				return div.innerHTML
			}

			// Image operations
			function copyImageUrl(url) {
				const fullUrl = url.startsWith("http") ? url : window.location.origin + url
				navigator.clipboard
					.writeText(fullUrl)
					.then(() => {
						showAlert("URL copied to clipboard!", "success")
					})
					.catch(() => {
						showAlert("Failed to copy URL", "error")
					})
			}

			// Image preview and operations
			let currentPreviewImage = null

			function showImagePreview(imageId, imageUrl, imageData) {
				// Validate and sanitize inputs
				if (!imageId || !imageUrl || !imageData) {
					showAlert("Invalid image data", "error")
					return
				}

				currentPreviewImage = imageData

				document.getElementById("preview-image").src = escapeHtml(imageUrl)

				// Safely populate preview info
				const previewInfo = document.getElementById("preview-info")
				previewInfo.innerHTML = ""

				const createInfoElement = (label, value) => {
					const p = document.createElement("p")
					const strong = document.createElement("strong")
					strong.textContent = label + ": "
					p.appendChild(strong)
					p.appendChild(document.createTextNode(value))
					return p
				}

				previewInfo.appendChild(createInfoElement("ID", imageData.id || imageId))
				previewInfo.appendChild(createInfoElement("Filename", imageData.filename || "Unknown"))
				previewInfo.appendChild(createInfoElement("Size", Math.round((imageData.size || 0) / 1024) + "KB"))
				previewInfo.appendChild(
					createInfoElement("Dimensions", (imageData.width || 0) + "x" + (imageData.height || 0))
				)
				previewInfo.appendChild(createInfoElement("Format", imageData.format || "Unknown"))
				previewInfo.appendChild(
					createInfoElement(
						"Created",
						imageData.created ? new Date(imageData.created).toLocaleDateString() : "Unknown"
					)
				)

				document.getElementById("image-preview-modal").style.display = "flex"
			}

			// Resize/Crop Modal State
			let currentResizeTab = "resize"
			let cropData = { x: 0, y: 0, width: 0, height: 0 }
			let cropCanvas, cropCtx, cropImage
			let isDragging = false
			let startX, startY
			let originalImageData = null

			function resizeCurrentImage() {
				if (currentPreviewImage) {
					closeModal("image-preview-modal")
					resizeImage(currentPreviewImage.id, currentPreviewImage.url)
				}
			}

			function deleteCurrentImage() {
				if (currentPreviewImage) {
					closeModal("image-preview-modal")
					deleteImage(currentPreviewImage.id)
				}
			}

			function switchResizeTab(tab) {
				currentResizeTab = tab

				// Update tab buttons
				document.getElementById("resize-tab").style.background = tab === "resize" ? "#007acc" : "#f5f5f5"
				document.getElementById("resize-tab").style.color = tab === "resize" ? "white" : "#666"
				document.getElementById("crop-tab").style.background = tab === "crop" ? "#007acc" : "#f5f5f5"
				document.getElementById("crop-tab").style.color = tab === "crop" ? "white" : "#666"

				// Show/hide panels
				document.getElementById("resize-panel").style.display = tab === "resize" ? "block" : "none"
				document.getElementById("crop-panel").style.display = tab === "crop" ? "block" : "none"

				if (tab === "crop") {
					initCropCanvas()
				}
			}

			function resizeImage(imageId, imageUrl) {
				currentImageId = imageId
				currentResizeTab = "resize"

				// Reset form
				document.getElementById("resize-width").value = ""
				document.getElementById("resize-height").value = ""
				document.getElementById("resize-quality").value = "90"
				document.getElementById("quality-value").textContent = "90"
				document.getElementById("resize-format").value = "png"
				document.getElementById("maintain-aspect").checked = true

				// Load image for preview
				const img = new Image()
				img.crossOrigin = "anonymous"
				img.onload = function () {
					originalImageData = { width: img.naturalWidth, height: img.naturalHeight, url: imageUrl }
					document.getElementById("resize-preview-image").src = imageUrl
					document.getElementById("resize-preview-image").style.display = "block"
					document.getElementById("resize-preview-text").style.display = "none"
					updateResizePreview()

					// Initialize crop canvas
					cropImage = img
				}
				img.src = imageUrl

				// Show modal
				switchResizeTab("resize")
				document.getElementById("resize-modal").style.display = "flex"
			}

			function updateResizePreview() {
				if (!originalImageData) return

				const width = parseInt(document.getElementById("resize-width").value) || null
				const height = parseInt(document.getElementById("resize-height").value) || null
				const maintainAspect = document.getElementById("maintain-aspect").checked

				let displayWidth, displayHeight

				if (width && height) {
					displayWidth = width
					displayHeight = height
				} else if (width) {
					displayWidth = width
					displayHeight = maintainAspect
						? Math.round(width * (originalImageData.height / originalImageData.width))
						: originalImageData.height
				} else if (height) {
					displayHeight = height
					displayWidth = maintainAspect
						? Math.round(height * (originalImageData.width / originalImageData.height))
						: originalImageData.width
				} else {
					displayWidth = originalImageData.width
					displayHeight = originalImageData.height
				}

				// Update info
				const format = document.getElementById("resize-format").value.toUpperCase()
				const quality = document.getElementById("resize-quality").value
				const estimatedSize = Math.round((displayWidth * displayHeight * 3 * (quality / 100)) / 1024)

				document.getElementById("resize-info").innerHTML = `
					<strong>Original:</strong> ${originalImageData.width} √ó ${originalImageData.height}px<br>
					<strong>New Size:</strong> ${displayWidth} √ó ${displayHeight}px<br>
					<strong>Format:</strong> ${format} @ ${quality}% quality<br>
					<strong>Est. Size:</strong> ~${estimatedSize}KB
				`
			}

			function initCropCanvas() {
				if (!cropImage) return

				cropCanvas = document.getElementById("crop-canvas")
				cropCtx = cropCanvas.getContext("2d")

				// Set canvas size to fit image
				const maxWidth = 380
				const maxHeight = 400
				const imgRatio = cropImage.width / cropImage.height

				let canvasWidth, canvasHeight
				if (imgRatio > maxWidth / maxHeight) {
					canvasWidth = maxWidth
					canvasHeight = maxWidth / imgRatio
				} else {
					canvasHeight = maxHeight
					canvasWidth = maxHeight * imgRatio
				}

				cropCanvas.width = canvasWidth
				cropCanvas.height = canvasHeight

				// Draw image
				cropCtx.drawImage(cropImage, 0, 0, canvasWidth, canvasHeight)

				// Initialize crop area (center 80%)
				const margin = 0.1
				cropData = {
					x: canvasWidth * margin,
					y: canvasHeight * margin,
					width: canvasWidth * (1 - 2 * margin),
					height: canvasHeight * (1 - 2 * margin),
				}

				drawCropOverlay()

				// Add event listeners
				cropCanvas.onmousedown = startCrop
				cropCanvas.onmousemove = updateCrop
				cropCanvas.onmouseup = endCrop
				cropCanvas.onmouseleave = endCrop
			}

			function startCrop(e) {
				const rect = cropCanvas.getBoundingClientRect()
				startX = e.clientX - rect.left
				startY = e.clientY - rect.top
				isDragging = true

				cropData.x = startX
				cropData.y = startY
				cropData.width = 0
				cropData.height = 0
			}

			function updateCrop(e) {
				if (!isDragging) return

				const rect = cropCanvas.getBoundingClientRect()
				const currentX = e.clientX - rect.left
				const currentY = e.clientY - rect.top

				cropData.width = currentX - startX
				cropData.height = currentY - startY

				// Handle negative dimensions
				if (cropData.width < 0) {
					cropData.x = currentX
					cropData.width = Math.abs(cropData.width)
				} else {
					cropData.x = startX
				}

				if (cropData.height < 0) {
					cropData.y = currentY
					cropData.height = Math.abs(cropData.height)
				} else {
					cropData.y = startY
				}

				// Apply aspect ratio if selected
				const aspectSelect = document.getElementById("crop-aspect")
				if (aspectSelect.value !== "free") {
					const aspectRatio = parseFloat(aspectSelect.value)
					cropData.height = cropData.width / aspectRatio
				}

				drawCropOverlay()
			}

			function endCrop() {
				isDragging = false
				updateCropInfo()
			}

			function drawCropOverlay() {
				// Redraw image
				cropCtx.clearRect(0, 0, cropCanvas.width, cropCanvas.height)
				cropCtx.drawImage(cropImage, 0, 0, cropCanvas.width, cropCanvas.height)

				// Draw darkened overlay
				cropCtx.fillStyle = "rgba(0, 0, 0, 0.5)"
				cropCtx.fillRect(0, 0, cropCanvas.width, cropCanvas.height)

				// Clear crop area
				cropCtx.clearRect(cropData.x, cropData.y, cropData.width, cropData.height)
				cropCtx.drawImage(cropImage, 0, 0, cropCanvas.width, cropCanvas.height)
				cropCtx.fillStyle = "rgba(0, 0, 0, 0.5)"
				cropCtx.fillRect(0, 0, cropCanvas.width, cropCanvas.height)
				cropCtx.clearRect(cropData.x, cropData.y, cropData.width, cropData.height)

				// Redraw just the crop area
				const scaleX = cropImage.width / cropCanvas.width
				const scaleY = cropImage.height / cropCanvas.height
				cropCtx.drawImage(
					cropImage,
					cropData.x * scaleX,
					cropData.y * scaleY,
					cropData.width * scaleX,
					cropData.height * scaleY,
					cropData.x,
					cropData.y,
					cropData.width,
					cropData.height
				)

				// Draw crop box
				cropCtx.strokeStyle = "#007acc"
				cropCtx.lineWidth = 2
				cropCtx.strokeRect(cropData.x, cropData.y, cropData.width, cropData.height)

				// Draw corner handles
				const handleSize = 8
				cropCtx.fillStyle = "#007acc"
				cropCtx.fillRect(cropData.x - handleSize / 2, cropData.y - handleSize / 2, handleSize, handleSize)
				cropCtx.fillRect(
					cropData.x + cropData.width - handleSize / 2,
					cropData.y - handleSize / 2,
					handleSize,
					handleSize
				)
				cropCtx.fillRect(
					cropData.x - handleSize / 2,
					cropData.y + cropData.height - handleSize / 2,
					handleSize,
					handleSize
				)
				cropCtx.fillRect(
					cropData.x + cropData.width - handleSize / 2,
					cropData.y + cropData.height - handleSize / 2,
					handleSize,
					handleSize
				)
			}

			function updateCropAspect() {
				if (cropData.width > 0) {
					const aspectSelect = document.getElementById("crop-aspect")
					if (aspectSelect.value !== "free") {
						const aspectRatio = parseFloat(aspectSelect.value)
						cropData.height = cropData.width / aspectRatio
						drawCropOverlay()
					}
				}
			}

			function updateCropInfo() {
				if (!cropCanvas) return

				const scaleX = cropImage.width / cropCanvas.width
				const scaleY = cropImage.height / cropCanvas.height

				const actualX = Math.round(cropData.x * scaleX)
				const actualY = Math.round(cropData.y * scaleY)
				const actualWidth = Math.round(cropData.width * scaleX)
				const actualHeight = Math.round(cropData.height * scaleY)

				document.getElementById("crop-x").value = actualX
				document.getElementById("crop-y").value = actualY
				document.getElementById("crop-width").value = actualWidth
				document.getElementById("crop-height").value = actualHeight
			}

			async function performResizeOrCrop() {
				if (currentResizeTab === "resize") {
					await performResize()
				} else {
					await performCrop()
				}
			}

			async function performResize() {
				const width = document.getElementById("resize-width").value || null
				const height = document.getElementById("resize-height").value || null
				const quality = document.getElementById("resize-quality").value
				const format = document.getElementById("resize-format").value

				if (!width && !height) {
					showAlert("Please specify width or height", "error")
					return
				}

				try {
					const response = await apiCall(`/api/images/${currentImageId}/resize`, {
						method: "POST",
						body: JSON.stringify({ width, height, quality, format }),
					})

					showAlert("Image resized successfully!", "success")
					closeModal("resize-modal")
					loadImages()
				} catch (error) {
					// Error already shown by apiCall
				}
			}

			async function performCrop() {
				if (!cropData.width || !cropData.height) {
					showAlert("Please select a crop area", "error")
					return
				}

				const scaleX = cropImage.width / cropCanvas.width
				const scaleY = cropImage.height / cropCanvas.height

				const left = Math.round(cropData.x * scaleX)
				const top = Math.round(cropData.y * scaleY)
				const width = Math.round(cropData.width * scaleX)
				const height = Math.round(cropData.height * scaleY)

				try {
					const response = await apiCall(`/api/images/${currentImageId}/crop`, {
						method: "POST",
						body: JSON.stringify({ left, top, width, height }),
					})

					showAlert("Image cropped successfully!", "success")
					closeModal("resize-modal")
					loadImages()
				} catch (error) {
					// Error already shown by apiCall
				}
			}

			async function deleteImage(imageId) {
				if (!confirm("Are you sure you want to delete this image?")) return

				try {
					await apiCall(`/api/images/${imageId}`, { method: "DELETE" })
					showAlert("Image deleted successfully!", "success")
					loadImages()
				} catch (error) {
					// Error already shown by apiCall
				}
			}

			// Utility functions
			function showAlert(message, type) {
				const container = document.getElementById("alert-container")
				const alert = document.createElement("div")
				alert.className = `alert alert-${type}`
				alert.textContent = message

				container.appendChild(alert)

				setTimeout(() => {
					container.removeChild(alert)
				}, 5000)
			}

			function closeModal(modalId) {
				const modal = document.getElementById(modalId)
				if (modal) {
					modal.style.display = "none"
				}
			}

			// Add click-outside-to-close functionality for modals
			document.addEventListener("click", function (e) {
				if (e.target.classList.contains("modal")) {
					closeModal(e.target.id)
				}
			})

			// Enter key handling
			document.addEventListener("keypress", function (e) {
				if (e.key === "Enter") {
					const loginForm = document.getElementById("login-form")
					const verify2FAForm = document.getElementById("verify-2fa")
					const setup2FAForm = document.getElementById("setup-2fa")

					if (loginForm && loginForm.style.display !== "none") {
						login()
					} else if (verify2FAForm && verify2FAForm.style.display !== "none") {
						verify2FA()
					} else if (setup2FAForm && setup2FAForm.style.display !== "none") {
						verifySetup()
					}
				}
			})
		</script>
	</body>
</html>
